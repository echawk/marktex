#!/bin/sh
# Purpose here is to get all of the lines that are between '@l' tokens
# into their own tex file. This will then be '\input'ed into the file
# generated by lowdown

# count and file are the varaibles that we need to keep track of.
# this is what is responsible for handling the @l tokens, and latex
# code in between them

USAGE="Usage: marktex [-lgwph] [-f file]"
HELP="$USAGE
-f, --file FILE
	Set the input file to FILE
-l, --latex
	Set the output format to LaTeX
-g, --groff
	Set the output format to groff
-w, --html
	Set the output format to html
-p, --plain
	Set the output format to be markdown (clears the document of any extensions)
-h, --help
	Print this message
"

for arg in "$@"
do
	case $arg in
		-l|--latex)
			shift
			;;
		-g|--groff)
			shift
			;;
		-w|--html)
			shift
			;;
		-p|--plain)
			shift
			;;
		-h|--help)
			shift
			printf "$HELP"
			exit 1
			;;
		-f|--file)
			shift
			file="$1"
			shift
			;;
		*)
			shift
			;;
	esac
done

[ -z "$file" ] && echo "$USAGE" && echo "No file! Exiting..." && exit 1

TEXCC=${TEXCC:-pdflatex}
GENFILES="$(mktemp)"
# Handle the LaTeX blocks
count=0
cp "${file}" "copy-${file}"
sed -n "/^@r$/=" "${file}" | awk '{if (NR % 2 == 0) {print $1} else {printf $1 "," }}' | while read -r LINE
do
	start=${LINE%%,*}
	end=${LINE##*,}
	cf="${count}-${file}.tex"
	sed -n "${start},${end}p" "${file}" > "$cf"
	sed -i "/@r/d" "$cf"
	sed "${start},${end}s/.*/@input@${cf}@/g" "copy-${file}" > "copy-${cf%%.*}"
	mv "copy-${cf%%.*}" "copy-${file}"
	echo "$cf" >> "$GENFILES"
	count=$((count + 1))
done

# Create the code files; both in the output document format and as an independent file (if applicable)
count=0
CODEBLOCK=N # Global variable to determine whether or not we have a code block in the file; if Y, then \usepackage[dvipsnames]{xcolor}
ptrn='```@C@?[a-z]*@?[a-z]*'

CODESRCFILES="$(grep -E "${ptrn}" "${file}" | cut -d"@" -f4 | sort -u)"

[ -n "$CODESRCFILES" ] && {
	for srcf in $CODESRCFILES
	do
		rm -v "$srcf"
	done
}

sed -E -n "/^${ptrn}/=" "${file}" | awk '{if (NR % 2 == 0) { print $1 } else { printf $1 "," }}' | while read -r LINE
do
	start=${LINE%%,*}
	end=${LINE##*,}
	lang=$(sed -n "${start}p" "${file}" | cut -d'@' -f3)
	[ -n "$(sed -n "${start}p" "${file}" | cut -d'@' -f4)" ] && langfile="$(sed -n "${start}p" "${file}" | cut -d'@' -f4)" || langfile=""
	tl="${count}-code-${file}.tmp.${lang}"
	sed -n "${start},${end}p" "${file}" > "$tl"
	sed -E -i "/$ptrn/d" "$tl"
	[ -n "$langfile" ] && cat "$tl" >> "$langfile"
	source-highlight --src-lang "${lang}" --out-format latexcolor -o "${tl%%.*}.tex" -i "$tl"
	rm "$tl"
	CODEBLOCK=Y
	sed "${start},${end}s/.*/@input@${tl%%.*}.tex@/g" "copy-${file}" > "copy-${count}-${file}"
	mv "copy-${count}-${file}" "copy-${file}"
	echo "${tl%%.*}.tex" >> "$GENFILES"
	count=$((count + 1))
done

# Create the citation files
count=0
sed -n "/@c.*@c.*/=" "${file}" | while read -r LINE
do
	cf="${count}-cite-${file}.tex"
	sed -n "${LINE}p" "${file}" > "$cf"
	sed -i -E -e "s=^[^@]*@c=@c=" -e "s/@c(.*)@c/\\\\autocite{\1}/g" "$cf"
	sed "${LINE}s/@c.*@c/@input@${cf}@/" "copy-${file}" > "copy-${count}-${file}"
	mv "copy-${count}-${file}" "copy-${file}"
	echo "$cf" >> "$GENFILES"
	count=$((count + 1))
done

# Handle the Preamble block; this is only ran *once*
# Create the Preamble file
if grep -E -q "^@p$" "${file}"
then
	PREAM=$(sed -n "/^@p$/=" "${file}" | awk '{if (NR % 2 == 0) {print $1} else {printf $1 "," }}')
	start=${PREAM%%,*}
	end=${PREAM##*,}
	sed -n "${start},${end}p" "${file}" > "preamble-${file}.tex"
	sed -i "/@p/d" "preamble-${file}.tex"
	sed -i "${start},${end}s/.*/@pre@preamble-${file}.tex@/g" "copy-${file}"
	echo "preamble-${file}.tex" >> "$GENFILES"
fi
# Now we are on to the @m tokens
#count=0; sed -n "/@m/=" ${file} | while read LINE
#do \
#	sed -n "${LINE}p" ${file} > ${count}-math-${file}.tex
#	sed -i -e "s=^[^@]*@m=@m=" -e "s/@m/$/g" ${count}-math-${file}.tex
#	sed "${LINE}s/@m.*@m/@input{${count}-math-${file}.tex}/" copy-${file} > copy-${count}-${file}
#	mv copy-${count}-${file} copy-${file}
#	count=$((count + 1))
#done

# Get rid of duplicate lines
uniq "copy-${file}" > "detex-${file}"
rm "copy-${file}"

# Comile the cleaned markdown with lowdown into the proper output format
lowdown -s -Tlatex --parse-math "detex-${file}" -o "${file}.tex";
rm "detex-${file}"

# Add in the preamble and the actually input the '@input' files
if grep -q "@pre@" "${file}.tex"
then
	PREAMINC=$(grep "@pre@" "${file}.tex" | sed -E "s=@pre@(.*)@=input{\1}=")
	sed -i -E  "s=^(\\\\documentclass\[[a-zA-Z0-9,]*\]\{[a-zA-Z]*})$=\1\n\n\\\\$PREAMINC=" "${file}.tex"
	sed -i -E "s=^@pre@.*$==" "${file}.tex"
fi
sed -i -E "s=@input@([^@]*)@=\\\\input{\1}=" "${file}.tex"

# Compile with the right compiler
${TEXCC} "${file}.tex"

# Remove temporary files
for f in $(cat "$GENFILES")
do
	rm -v "$f"
done
rm "$GENFILES"
