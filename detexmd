#!/bin/sh
# Purpose here is to get all of the lines that are between '@l' tokens
# into their own tex file. This will then be '\input'ed into the file
# generated by lowdown

# count and file are the varaibles that we need to keep track of.
# this is what is responsible for handling the @l tokens, and latex
# code in between them

count=0; file=l.md; cp ${file} copy-${file}; sed -n "/^@l$/=" ${file} | awk '{if (NR % 2 == 0) {print $1} else {printf $1 "\t" }}' | while read LINE; \
do \
	start=$(echo $LINE | cut -d' ' -f1); \
	end=$(echo $LINE | cut -d' ' -f2); \
	sed -n "${start},${end}p" ${file} > ${count}-${file}.tex; \
	sed -i "/@l/d" ${count}-${file}.tex; \
	sed "${start},${end}s/.*/@input{${count}-${file}.tex}/g" copy-${file} > copy-${count}-${file}; \
	mv copy-${count}-${file} copy-${file} ; \
	count=$((count + 1)); \
done
# Now we are on to the @m tokens
count=0; file=l.md; sed -n "/@m/=" ${file} | while read LINE; \
do \
	sed -n "${LINE}p" ${file} > ${count}-math-${file}.tex; \
	sed -i -e "s=^[^@]*@m=@m=" -e "s/@m/$/g" ${count}-math-${file}.tex; \
	sed "${LINE}s/@m.*@m/@input{${count}-math-${file}.tex}/" copy-${file} > copy-${count}-${file}; \
	mv copy-${count}-${file} copy-${file} ; \
	count=$((count + 1)); \
done
uniq copy-${file} > detex-${file}
rm copy-${file}
